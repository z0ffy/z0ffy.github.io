{"pageProps":{"post":{"id":15,"title":"【vue router】动态路由匹配下的权限处理","created_at":"2024-11-06T08:36:19Z","updated_at":"2024-11-06T08:36:27Z","content":"### 基于路由的访问控制（Route-Based Access Control，RBAC）\r\n\r\n> 前端 routes.js 中定义完整路由，每个路由 meta 信息中的 role 来标识权限值。登陆之后通过用户的权限过滤完整路由，最终生成用户路由。\r\n\r\n#### 特点\r\n\r\n- 集中管理：在 routes.js 中集中管理所有路由及其权限信息。\r\n- 动态生成用户路由：用户登录时根据权限动态过滤路由，生成符合用户权限的路由配置。\r\n- 基于角色的访问控制：通过 meta.role 来管理和控制角色权限，可以支持多角色的访问权限需求。\r\n\r\n#### 流程\r\n\r\n- 定义完整路由表：在 routes.js 中定义所有路由和对应的 meta.role 信息。\r\n- 用户登录后获取权限：用户登录后，获取用户权限信息（如角色、权限 ID 等）。\r\n- 动态过滤路由：根据用户的权限信息过滤完整路由表，生成仅包含用户有权限访问的路由。\r\n- 动态注入路由表：将过滤后的路由表动态注入到路由配置中。\r\n\r\n### 业务背景\r\n\r\n> 基于上述流程。在实际业务中，如果用户进入无匹配路由页面时（**实际路由确实不存在、权限不足导致无匹配路由**），会重定向至 404\r\n> 页面（此动作由 vue-router 的 路由匹配完成）。\r\n>\r\n> [捕获所有路由或 404 Not found 路由](https://router.vuejs.org/zh/guide/essentials/dynamic-matching.html#捕获所有路由或-404-Not-found-路由)\r\n\r\n```javascript\r\n// 需在用户路由表生成后添加\r\nconst NOT_FOUND_ROUTE = {\r\n  name: 'NotFound',\r\n  path: '/:pathMatch(.*)*',\r\n  redirect: '/404',\r\n};\r\n```\r\n\r\n#### 问题\r\n\r\n通过以上操作，一旦匹配不到路由就会重定向至 404 页面。此时无法区分进入 404 的原因到底是因为 **实际路由不存在** 还是 **权限不足\r\n**\r\n**。\r\n\r\n#### 解决方案\r\n\r\n为了解决上述问题可以修改 **NotFound** 中的 **redirect** 如下:\r\n\r\n```javascript\r\nconst NOT_FOUND_ROUTE = {\r\n  name: 'NotFound',\r\n  path: '/:pathMatch(.*)*',\r\n  redirect: (to) => {\r\n    const allRoutes = router.getRoutes();\r\n    console.log(to);\r\n    console.log(allRoutes);\r\n    return '/404';\r\n  },\r\n};\r\n```\r\n\r\n在将 **redirect** 配置项设置为方法后：\r\n\r\n1. 参数 **to**：可以访问跳转前的路由信息，帮助了解用户试图访问的路径。\r\n2. 方法 **router.getRoutes**：可以获取所有已注册的路由表，便于进行权限和路径验证。\r\n\r\n在此基础上，需要实现以下两重判断：\r\n\r\n1. 路径存在性判断：利用 **to.path** 检查目标路径是否在路由表中。\r\n    - 若路径存在：说明目标路径已注册。（可忽略。~~进一步判断用户是否有权限访问。此时，如果用户跳转到了 **404**\r\n      页面，通常意味着当前用户没有访问该路径的权限。~~）\r\n    - 若路径不存在：说明路由没有进行注册。\r\n2. 增加标记：可以通过修改 **to.query** 或其他方式，标记跳转到 **404** 的原因，便于前端展示不同的提示内容。\r\n\r\n通过这种判断，能够精准地确认跳转至 **404** 的原因，进一步支持前端展示出更具体的权限提示信息。\r\n","author":"z0ffy","reactions":{"url":"https://api.github.com/repos/z0ffy/z0ffy.github.io/issues/15/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"labels":["published"]}},"__N_SSG":true}