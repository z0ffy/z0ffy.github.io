<!DOCTYPE html><html lang="zh-CN" id="html"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><title data-next-head="">【小程序】播放 pcm 流</title><meta name="description" content="### 实时播放 pcm 流

```javascript
export class PCMPlayer {
  constructor(option) {
    this.init(option);
  }

  init(option) {
    const defaultOption = " data-next-head=""/><meta name="keywords" content="【小程序】播放 pcm 流" data-next-head=""/><meta name="author" content="zoffy" data-next-head=""/><meta property="og:title" content="【小程序】播放 pcm 流" data-next-head=""/><meta property="og:description" content="### 实时播放 pcm 流

```javascript
export class PCMPlayer {
  constructor(option) {
    this.init(option);
  }

  init(option) {
    const defaultOption = " data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="og:url" content="https://zoffy.me" data-next-head=""/><link rel="shortcut icon" href="/favicon.ico"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/d87f76a63da4d35b.css" as="style"/><link rel="preload" href="/_next/static/css/2eb74dcba05ea63c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d87f76a63da4d35b.css" data-n-g=""/><link rel="stylesheet" href="/_next/static/css/2eb74dcba05ea63c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ffd07a3317375c1.js" defer=""></script><script src="/_next/static/chunks/framework-e9806f575cfe9302.js" defer=""></script><script src="/_next/static/chunks/main-db620d67651d390c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-dbf8774eddc5fa0f.js" defer=""></script><script src="/_next/static/chunks/914-e1d3cbc5fed1930c.js" defer=""></script><script src="/_next/static/chunks/7-4ba0364ffe417b24.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bid%5D-6d6e1eb16a4123ec.js" defer=""></script><script src="/_next/static/vXWzReuGooTKnwalJT7qz/_buildManifest.js" defer=""></script><script src="/_next/static/vXWzReuGooTKnwalJT7qz/_ssgManifest.js" defer=""></script></head><body class="dark:bg-black bg-slate-50"><div id="__next"><script>((e,i,s,u,m,a,l,h)=>{let d=document.documentElement,w=["light","dark"];function p(n){(Array.isArray(e)?e:[e]).forEach(y=>{let k=y==="class",S=k&&a?m.map(f=>a[f]||f):m;k?(d.classList.remove(...S),d.classList.add(a&&a[n]?a[n]:n)):d.setAttribute(y,n)}),R(n)}function R(n){h&&w.includes(n)&&(d.style.colorScheme=n)}function c(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}if(u)p(u);else try{let n=localStorage.getItem(i)||s,y=l&&n==="system"?c():n;p(y)}catch(n){}})("data-theme","theme","system",null,["light","dark"],null,true,true)</script><div class="flex flex-col h-screen container w-full md:w-3/4 xl:w-1/2"><header><div class="my-10 flex self-center flex-row justify-between"><div class="flex self-center flex-row justify-between"><a class="md:text-2xl text-xl cursor-pointer dark:hover:text-white dark:text-gray-400 text-gray-500 hover:text-black transition-colors duration-200 font-en" href="/">cd ..</a></div><div class="self-center text-sm sm:text-lg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2em" height="2em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M12 5q-.425 0-.712-.288Q11 4.425 11 4V2q0-.425.288-.713Q11.575 1 12 1t.713.287Q13 1.575 13 2v2q0 .425-.287.712Q12.425 5 12 5Zm4.95 2.05q-.275-.275-.275-.688q0-.412.275-.712l1.4-1.425q.3-.3.712-.3q.413 0 .713.3q.275.275.275.7q0 .425-.275.7L18.35 7.05q-.275.275-.7.275q-.425 0-.7-.275ZM20 13q-.425 0-.712-.288Q19 12.425 19 12t.288-.713Q19.575 11 20 11h2q.425 0 .712.287q.288.288.288.713t-.288.712Q22.425 13 22 13Zm-8 10q-.425 0-.712-.288Q11 22.425 11 22v-2q0-.425.288-.712Q11.575 19 12 19t.713.288Q13 19.575 13 20v2q0 .425-.287.712Q12.425 23 12 23ZM5.65 7.05l-1.425-1.4q-.3-.3-.3-.725t.3-.7q.275-.275.7-.275q.425 0 .7.275L7.05 5.65q.275.275.275.7q0 .425-.275.7q-.3.275-.7.275q-.4 0-.7-.275Zm12.7 12.725l-1.4-1.425q-.275-.3-.275-.712q0-.413.275-.688q.275-.275.688-.275q.412 0 .712.275l1.425 1.4q.3.275.287.7q-.012.425-.287.725q-.3.3-.725.3t-.7-.3ZM2 13q-.425 0-.712-.288Q1 12.425 1 12t.288-.713Q1.575 11 2 11h2q.425 0 .713.287Q5 11.575 5 12t-.287.712Q4.425 13 4 13Zm2.225 6.775q-.275-.275-.275-.7q0-.425.275-.7L5.65 16.95q.275-.275.688-.275q.412 0 .712.275q.3.3.3.713q0 .412-.3.712l-1.4 1.4q-.3.3-.725.3t-.7-.3ZM12 18q-2.5 0-4.25-1.75T6 12q0-2.5 1.75-4.25T12 6q2.5 0 4.25 1.75T18 12q0 2.5-1.75 4.25T12 18Zm0-2q1.65 0 2.825-1.175Q16 13.65 16 12q0-1.65-1.175-2.825Q13.65 8 12 8q-1.65 0-2.825 1.175Q8 10.35 8 12q0 1.65 1.175 2.825Q10.35 16 12 16Z"></path></svg></div></div></header><main class="grow"><div><div class="flex flex-col mb-2"><div class="text-4xl sm:text-4xl font-medium dark:text-gray-200">【小程序】播放 pcm 流</div><div class="sm:text-lg text-sm mt-2 dark:text-gray-400"><span>1月1日</span> / <span>1月21日</span></div></div><br/><div class="font-normal"><h1 class="sm:text-4xl text-3xl my-12 mb-6 dark:text-white font-medium">实时播放 pcm 流</h1>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">class</span><span> </span><span class="token" style="color:#DD4A68">PCMPlayer</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span>  </span><span class="token" style="color:#DD4A68">constructor</span><span class="token" style="color:#999">(</span><span class="token parameter">option</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">init</span><span class="token" style="color:#999">(</span><span>option</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">6</span><span>  </span><span class="token" style="color:#DD4A68">init</span><span class="token" style="color:#999">(</span><span class="token parameter">option</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">7</span><span>    </span><span class="token" style="color:#07a">const</span><span> defaultOption </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">8</span><span>      </span><span class="token literal-property" style="color:#905">inputCodec</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;Int16&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:slategray">// 传入的数据是采用多少位编码，默认16位</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">9</span><span>      </span><span class="token literal-property" style="color:#905">channels</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">1</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:slategray">// 声道数</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">10</span><span>      </span><span class="token literal-property" style="color:#905">sampleRate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">8000</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:slategray">// 采样率 单位Hz</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">11</span><span>      </span><span class="token literal-property" style="color:#905">flushTime</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">1000</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:slategray">// 缓存时间 单位 ms</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">12</span><span>      </span><span class="token literal-property" style="color:#905">fftSize</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">2048</span><span> </span><span class="token" style="color:slategray">// analyserNode fftSize</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">13</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">15</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Object</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">assign</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span> defaultOption</span><span class="token" style="color:#999">,</span><span> option</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// 实例最终配置参数</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">16</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Float32Array</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// 样本存放区域</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">17</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">interval</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#DD4A68">setInterval</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">flush</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">bind</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">flushTime</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">18</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">convertValue</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getConvertValue</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">19</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">typedArray</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getTypedArray</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">20</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">initAudioContext</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">21</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">bindAudioContextEvent</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">22</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">23</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">24</span><span>  </span><span class="token" style="color:#DD4A68">getConvertValue</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">25</span><span>    </span><span class="token" style="color:slategray">// 根据传入的目标编码位数</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">26</span><span>    </span><span class="token" style="color:slategray">// 选定转换数据所需要的基本值</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">27</span><span>    </span><span class="token" style="color:#07a">const</span><span> inputCodecs </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">28</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Int8&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">128</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">29</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Int16&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">32768</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">30</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Int32&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">2147483648</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">31</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Float32&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">32</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">33</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">!</span><span>inputCodecs</span><span class="token" style="color:#999">[</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">inputCodec</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span> </span><span class="token control-flow" style="color:#07a">throw</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Error</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;wrong codec.please input one of these codecs:Int8,Int16,Int32,Float32&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">34</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> inputCodecs</span><span class="token" style="color:#999">[</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">inputCodec</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">35</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">36</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">37</span><span>  </span><span class="token" style="color:#DD4A68">getTypedArray</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">38</span><span>    </span><span class="token" style="color:slategray">// 根据传入的目标编码位数</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">39</span><span>    </span><span class="token" style="color:slategray">// 选定前端的所需要的保存的二进制数据格式</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">40</span><span>    </span><span class="token" style="color:slategray">// 完整TypedArray请看文档</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">41</span><span>    </span><span class="token" style="color:slategray">// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">42</span><span>    </span><span class="token" style="color:#07a">const</span><span> typedArrays </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">43</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Int8&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Int8Array</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">44</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Int16&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Int16Array</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">45</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Int32&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Int32Array</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">46</span><span>      </span><span class="token string-property" style="color:#905">&#x27;Float32&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Float32Array</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">47</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">48</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">!</span><span>typedArrays</span><span class="token" style="color:#999">[</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">inputCodec</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span> </span><span class="token control-flow" style="color:#07a">throw</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Error</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;wrong codec.please input one of these codecs:Int8,Int16,Int32,Float32&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">49</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> typedArrays</span><span class="token" style="color:#999">[</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">inputCodec</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">50</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">51</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">52</span><span>  </span><span class="token" style="color:#DD4A68">initAudioContext</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">53</span><span>    </span><span class="token" style="color:slategray">// 初始化音频上下文的东西</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">54</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#DD4A68">createWebAudioContext</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">55</span><span>    </span><span class="token" style="color:slategray">// 控制音量的 GainNode</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">56</span><span>    </span><span class="token" style="color:slategray">// https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createGain</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">57</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">gainNode</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">createGain</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">58</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">gainNode</span><span class="token" style="color:#999">.</span><span class="token property-access">gain</span><span class="token" style="color:#999">.</span><span class="token property-access">value</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">1</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">59</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">gainNode</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">connect</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token property-access">destination</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">60</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">startTime</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token property-access">currentTime</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">61</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">analyserNode</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">createAnalyser</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">62</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">analyserNode</span><span class="token" style="color:#999">.</span><span class="token property-access">fftSize</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">fftSize</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">63</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">64</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">65</span><span>  </span><span class="token" style="color:#07a">static</span><span> </span><span class="token" style="color:#DD4A68">isTypedArray</span><span class="token" style="color:#999">(</span><span class="token parameter">data</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">66</span><span>    </span><span class="token" style="color:slategray">// 检测输入的数据是否为 TypedArray 类型或 ArrayBuffer 类型</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">67</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">.</span><span class="token property-access">byteLength</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span><span> data</span><span class="token" style="color:#999">.</span><span class="token property-access">buffer</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span><span> data</span><span class="token" style="color:#999">.</span><span class="token property-access">buffer</span><span> </span><span class="token" style="color:#07a">instanceof</span><span> </span><span class="token" style="color:#DD4A68">ArrayBuffer</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">||</span><span> data </span><span class="token" style="color:#07a">instanceof</span><span> </span><span class="token" style="color:#DD4A68">ArrayBuffer</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">68</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">69</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">70</span><span>  </span><span class="token" style="color:#DD4A68">isSupported</span><span class="token" style="color:#999">(</span><span class="token parameter">data</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">71</span><span>    </span><span class="token" style="color:slategray">// 数据类型是否支持</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">72</span><span>    </span><span class="token" style="color:slategray">// 目前支持 ArrayBuffer 或者 TypedArray</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">73</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">!</span><span class="token maybe-class-name">PCMPlayer</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">isTypedArray</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span> </span><span class="token control-flow" style="color:#07a">throw</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Error</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;请传入ArrayBuffer或者任意TypedArray&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">74</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#905">true</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">75</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">76</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">77</span><span>  </span><span class="token" style="color:#DD4A68">feed</span><span class="token" style="color:#999">(</span><span class="token parameter">data</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">78</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">isSupported</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">79</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">80</span><span>    </span><span class="token" style="color:slategray">// 获取格式化后的buffer</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">81</span><span>    data </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getFormattedValue</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">82</span><span>    </span><span class="token" style="color:slategray">// 开始拷贝buffer数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">83</span><span>    </span><span class="token" style="color:slategray">// 新建一个Float32Array的空间</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">84</span><span>    </span><span class="token" style="color:#07a">const</span><span> tmp </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Float32Array</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> data</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">85</span><span>    </span><span class="token" style="color:slategray">// console.log(data, this.samples, this.samples.length)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">86</span><span>    </span><span class="token" style="color:slategray">// 复制当前的实例的buffer值（历史buff)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">87</span><span>    </span><span class="token" style="color:slategray">// 从头（0）开始复制</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">88</span><span>    tmp</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">set</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">89</span><span>    </span><span class="token" style="color:slategray">// 复制传入的新数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">90</span><span>    </span><span class="token" style="color:slategray">// 从历史buff位置开始</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">91</span><span>    tmp</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">set</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">92</span><span>    </span><span class="token" style="color:slategray">// 将新的完整buff数据赋值给samples</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">93</span><span>    </span><span class="token" style="color:slategray">// interval定时器也会从samples里面播放数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">94</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> tmp</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">95</span><span>    </span><span class="token" style="color:slategray">// console.log(&#x27;this.samples&#x27;, this.samples)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">96</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">97</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">98</span><span>  </span><span class="token" style="color:#DD4A68">getFormattedValue</span><span class="token" style="color:#999">(</span><span class="token parameter">data</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">99</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>data </span><span class="token" style="color:#07a">instanceof</span><span> </span><span class="token" style="color:#DD4A68">ArrayBuffer</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">100</span><span>      data </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">this</span><span class="token" style="color:#999">.</span><span class="token" style="color:#DD4A68">typedArray</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">101</span><span>    </span><span class="token" style="color:#999">}</span><span> </span><span class="token control-flow" style="color:#07a">else</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">102</span><span>      data </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">this</span><span class="token" style="color:#999">.</span><span class="token" style="color:#DD4A68">typedArray</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">.</span><span class="token property-access">buffer</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">103</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">104</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">105</span><span>    </span><span class="token" style="color:#07a">let</span><span> float32 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Float32Array</span><span class="token" style="color:#999">(</span><span>data</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">106</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">107</span><span>    </span><span class="token control-flow" style="color:#07a">for</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">let</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">;</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> data</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span class="token" style="color:#999">;</span><span> i</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">++</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">108</span><span>      </span><span class="token" style="color:slategray">// buffer 缓冲区的数据，需要是IEEE754 里32位的线性PCM，范围从-1到+1</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">109</span><span>      </span><span class="token" style="color:slategray">// 所以对数据进行除法</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">110</span><span>      </span><span class="token" style="color:slategray">// 除以对应的位数范围，得到-1到+1的数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">111</span><span>      </span><span class="token" style="color:slategray">// float32[i] = data[i] / 0x8000;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">112</span><span>      float32</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> data</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">convertValue</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">113</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">114</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> float32</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">115</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">116</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">117</span><span>  </span><span class="token" style="color:#DD4A68">volume</span><span class="token" style="color:#999">(</span><span class="token parameter">volume</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">118</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">gainNode</span><span class="token" style="color:#999">.</span><span class="token property-access">gain</span><span class="token" style="color:#999">.</span><span class="token property-access">value</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> volume</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">119</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">120</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">121</span><span>  </span><span class="token" style="color:#DD4A68">destroy</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">122</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">interval</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">123</span><span>      </span><span class="token" style="color:#DD4A68">clearInterval</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">interval</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">124</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">125</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token null nil" style="color:#07a">null</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">126</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">close</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">then</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">127</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token null nil" style="color:#07a">null</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">128</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">129</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">130</span><span>  </span><span class="token" style="color:#DD4A68">flush</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">131</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">!</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span class="token" style="color:#999">)</span><span> </span><span class="token control-flow" style="color:#07a">return</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">132</span><span>    </span><span class="token" style="color:#07a">const</span><span> self </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">133</span><span>    </span><span class="token" style="color:#07a">const</span><span> bufferSource </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">createBufferSource</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">134</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">typeof</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">onended</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span><span> </span><span class="token" style="color:#690">&#x27;function&#x27;</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">135</span><span>      bufferSource</span><span class="token" style="color:#999">.</span><span class="token method-variable function-variable method property-access" style="color:#DD4A68">onended</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">function</span><span> </span><span class="token" style="color:#999">(</span><span class="token parameter">event</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">136</span><span>        self</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">onended</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">,</span><span> event</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">137</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">138</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">139</span><span>    </span><span class="token" style="color:#07a">const</span><span> length </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">channels</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">140</span><span>    </span><span class="token" style="color:#07a">const</span><span> audioBuffer </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">createBuffer</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">channels</span><span class="token" style="color:#999">,</span><span> length</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">sampleRate</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">141</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">142</span><span>    </span><span class="token control-flow" style="color:#07a">for</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">let</span><span> channel </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">;</span><span> channel </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">channels</span><span class="token" style="color:#999">;</span><span> channel</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">++</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">143</span><span>      </span><span class="token" style="color:#07a">const</span><span> audioData </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> audioBuffer</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getChannelData</span><span class="token" style="color:#999">(</span><span>channel</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">144</span><span>      </span><span class="token" style="color:#07a">let</span><span> offset </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> channel</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">145</span><span>      </span><span class="token" style="color:#07a">let</span><span> decrement </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">50</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">146</span><span>      </span><span class="token control-flow" style="color:#07a">for</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">let</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">;</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> length</span><span class="token" style="color:#999">;</span><span> i</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">++</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">147</span><span>        audioData</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span class="token" style="color:#999">[</span><span>offset</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">148</span><span>        </span><span class="token" style="color:slategray">/* fadein */</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">149</span><span>        </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">50</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">150</span><span>          audioData</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span>audioData</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> i</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">50</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">151</span><span>        </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">152</span><span>        </span><span class="token" style="color:slategray">/* fadeout*/</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">153</span><span>        </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;=</span><span> </span><span class="token" style="color:#999">(</span><span>length </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">-</span><span> </span><span class="token" style="color:#905">51</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">154</span><span>          audioData</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span>audioData</span><span class="token" style="color:#999">[</span><span>i</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> decrement</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">--</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">50</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">155</span><span>        </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">156</span><span>        offset </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">channels</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">157</span><span>      </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">158</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">159</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">160</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">startTime</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token property-access">currentTime</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">161</span><span>      </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">startTime</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token property-access">currentTime</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">162</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">163</span><span>    </span><span class="token" style="color:slategray">// console.log(&#x27;start vs current &#x27; + this.startTime + &#x27; vs &#x27; + this.audioCtx.currentTime + &#x27; duration: &#x27; + audioBuffer.duration);</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">164</span><span>    </span><span class="token" style="color:slategray">// console.log(&#x27;start&#x27;, this.startTime);</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">165</span><span>    </span><span class="token" style="color:slategray">// console.log(&#x27;duration&#x27;, audioBuffer.duration);</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">166</span><span>    bufferSource</span><span class="token" style="color:#999">.</span><span class="token property-access">buffer</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> audioBuffer</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">167</span><span>    bufferSource</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">connect</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">gainNode</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">168</span><span>    bufferSource</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">connect</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">analyserNode</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// bufferSource连接到analyser</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">169</span><span>    bufferSource</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">start</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">startTime</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">170</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span class="token method property-access" style="color:#DD4A68">onstart</span><span class="token" style="color:#999">(</span><span>audioBuffer</span><span class="token" style="color:#999">.</span><span class="token property-access">duration</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">171</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">startTime</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> audioBuffer</span><span class="token" style="color:#999">.</span><span class="token property-access">duration</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">172</span><span>    </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">samples</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Float32Array</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">173</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">174</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">175</span><span>  </span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#DD4A68">pause</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">176</span><span>    </span><span class="token control-flow" style="color:#07a">await</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">suspend</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">177</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">178</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">179</span><span>  </span><span class="token" style="color:#07a">async</span><span> </span><span class="token control-flow" style="color:#07a">continue</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">180</span><span>    </span><span class="token control-flow" style="color:#07a">await</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">resume</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">181</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">182</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">183</span><span>  </span><span class="token" style="color:#DD4A68">bindAudioContextEvent</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">184</span><span>    </span><span class="token" style="color:#07a">const</span><span> self </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">185</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">typeof</span><span> self</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token property-access">onstatechange</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span><span> </span><span class="token" style="color:#690">&#x27;function&#x27;</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">186</span><span>      </span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token method-variable function-variable method property-access" style="color:#DD4A68">onstatechange</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">function</span><span> </span><span class="token" style="color:#999">(</span><span class="token parameter">event</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">187</span><span>        self</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span><span> self</span><span class="token" style="color:#999">.</span><span class="token property-access">option</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">onstatechange</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">this</span><span class="token" style="color:#999">,</span><span> event</span><span class="token" style="color:#999">,</span><span> self</span><span class="token" style="color:#999">.</span><span class="token property-access">audioCtx</span><span class="token" style="color:#999">.</span><span class="token property-access">state</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">188</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">189</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">190</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">191</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">192</span><span></span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">193</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">194</span><span></span><span class="token module" style="color:#07a">export</span><span> </span><span class="token module" style="color:#07a">default</span><span> </span><span class="token maybe-class-name">PCMPlayer</span><span class="token" style="color:#999">;</span></code></div></pre></div><br/><div></div><a class="float-right mt-10 sm:text-2xl text-xl text-gray-500 hover:text-black transition-colors duration-200 dark:text-gray-400 dark:hover:text-gray-100" href="/">cd ..</a></div></main><footer class="container mx-auto text-center text-gray-700 dark:text-gray-400"><div class="flex flex-row justify-center mb-5 space-x-5"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" fill-rule="evenodd" d="M3.5 3.25a.75.75 0 0 1 .75-.75C14.053 2.5 22 10.447 22 20.25a.75.75 0 0 1-1.5 0C20.5 11.275 13.225 4 4.25 4a.75.75 0 0 1-.75-.75zM3.5 19a2 2 0 1 1 4 0a2 2 0 0 1-4 0zm.75-9.5a.75.75 0 0 0 0 1.5a9.25 9.25 0 0 1 9.25 9.25a.75.75 0 0 0 1.5 0C15 14.313 10.187 9.5 4.25 9.5z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M4 20q-.825 0-1.412-.587Q2 18.825 2 18V6q0-.825.588-1.412Q3.175 4 4 4h16q.825 0 1.413.588Q22 5.175 22 6v12q0 .825-.587 1.413Q20.825 20 20 20ZM20 8l-7.475 4.675q-.125.075-.263.112q-.137.038-.262.038t-.262-.038q-.138-.037-.263-.112L4 8v10h16Zm-8 3l8-5H4ZM4 8v.25v-1.475v.025V6v.8v-.013V8.25V8v10Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" cursor="pointer" viewBox="0 0 16 16"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.75 14.25s-.5-2 .5-3c0 0-2 0-3.5-1.5s-1-4.5 0-5.5c-.5-1.5.5-2.5.5-2.5s1.5 0 2.5 1c1-.5 3.5-.5 4.5 0c1-1 2.5-1 2.5-1s1 1 .5 2.5c1 1 1.5 4 0 5.5s-3.5 1.5-3.5 1.5c1 1 .5 3 .5 3m-5-.5c-1.5.5-3-.5-3.5-1"></path></svg></div><div class="flex items-center flex-wrap mb-10 font-en justify-center"><span>©<!-- -->2025<!-- -->. </span><span>All rights reserved by </span><a href="https://github.com/z0ffy" class="text-blue-500 hover:text-blue-900 transition-colors duration-300">z0ffy</a><span>.</span></div></footer><div class="bottom-10 right-10 cursor-pointer fixed hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="opacity-0 duration-700 transition-opacity ease-in-out"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19h14a2 2 0 0 0 1.84-2.75L13.74 4a2 2 0 0 0-3.5 0l-7.1 12.25A2 2 0 0 0 4.89 19"></path></svg></div><div id="sakana-widget" class="cursor-pointer bottom-0 left-16 fixed hidden xl:block"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":26,"title":"【小程序】播放 pcm 流","created_at":"2025-01-01T17:32:02Z","updated_at":"2025-01-21T07:35:02Z","content":"### 实时播放 pcm 流\n\n```javascript\nexport class PCMPlayer {\n  constructor(option) {\n    this.init(option);\n  }\n\n  init(option) {\n    const defaultOption = {\n      inputCodec: 'Int16', // 传入的数据是采用多少位编码，默认16位\n      channels: 1, // 声道数\n      sampleRate: 8000, // 采样率 单位Hz\n      flushTime: 1000, // 缓存时间 单位 ms\n      fftSize: 2048 // analyserNode fftSize\n    };\n\n    this.option = Object.assign({}, defaultOption, option); // 实例最终配置参数\n    this.samples = new Float32Array(); // 样本存放区域\n    this.interval = setInterval(this.flush.bind(this), this.option.flushTime);\n    this.convertValue = this.getConvertValue();\n    this.typedArray = this.getTypedArray();\n    this.initAudioContext();\n    this.bindAudioContextEvent();\n  }\n\n  getConvertValue() {\n    // 根据传入的目标编码位数\n    // 选定转换数据所需要的基本值\n    const inputCodecs = {\n      'Int8': 128,\n      'Int16': 32768,\n      'Int32': 2147483648,\n      'Float32': 1\n    };\n    if (!inputCodecs[this.option.inputCodec]) throw new Error('wrong codec.please input one of these codecs:Int8,Int16,Int32,Float32');\n    return inputCodecs[this.option.inputCodec];\n  }\n\n  getTypedArray() {\n    // 根据传入的目标编码位数\n    // 选定前端的所需要的保存的二进制数据格式\n    // 完整TypedArray请看文档\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray\n    const typedArrays = {\n      'Int8': Int8Array,\n      'Int16': Int16Array,\n      'Int32': Int32Array,\n      'Float32': Float32Array\n    };\n    if (!typedArrays[this.option.inputCodec]) throw new Error('wrong codec.please input one of these codecs:Int8,Int16,Int32,Float32');\n    return typedArrays[this.option.inputCodec];\n  }\n\n  initAudioContext() {\n    // 初始化音频上下文的东西\n    this.audioCtx = createWebAudioContext();\n    // 控制音量的 GainNode\n    // https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createGain\n    this.gainNode = this.audioCtx.createGain();\n    this.gainNode.gain.value = 1;\n    this.gainNode.connect(this.audioCtx.destination);\n    this.startTime = this.audioCtx.currentTime;\n    this.analyserNode = this.audioCtx.createAnalyser();\n    this.analyserNode.fftSize = this.option.fftSize;\n  }\n\n  static isTypedArray(data) {\n    // 检测输入的数据是否为 TypedArray 类型或 ArrayBuffer 类型\n    return (data.byteLength \u0026\u0026 data.buffer \u0026\u0026 data.buffer instanceof ArrayBuffer) || data instanceof ArrayBuffer;\n  }\n\n  isSupported(data) {\n    // 数据类型是否支持\n    // 目前支持 ArrayBuffer 或者 TypedArray\n    if (!PCMPlayer.isTypedArray(data)) throw new Error('请传入ArrayBuffer或者任意TypedArray');\n    return true;\n  }\n\n  feed(data) {\n    this.isSupported(data);\n\n    // 获取格式化后的buffer\n    data = this.getFormattedValue(data);\n    // 开始拷贝buffer数据\n    // 新建一个Float32Array的空间\n    const tmp = new Float32Array(this.samples.length + data.length);\n    // console.log(data, this.samples, this.samples.length)\n    // 复制当前的实例的buffer值（历史buff)\n    // 从头（0）开始复制\n    tmp.set(this.samples, 0);\n    // 复制传入的新数据\n    // 从历史buff位置开始\n    tmp.set(data, this.samples.length);\n    // 将新的完整buff数据赋值给samples\n    // interval定时器也会从samples里面播放数据\n    this.samples = tmp;\n    // console.log('this.samples', this.samples)\n  }\n\n  getFormattedValue(data) {\n    if (data instanceof ArrayBuffer) {\n      data = new this.typedArray(data);\n    } else {\n      data = new this.typedArray(data.buffer);\n    }\n\n    let float32 = new Float32Array(data.length);\n\n    for (let i = 0; i \u003c data.length; i++) {\n      // buffer 缓冲区的数据，需要是IEEE754 里32位的线性PCM，范围从-1到+1\n      // 所以对数据进行除法\n      // 除以对应的位数范围，得到-1到+1的数据\n      // float32[i] = data[i] / 0x8000;\n      float32[i] = data[i] / this.convertValue;\n    }\n    return float32;\n  }\n\n  volume(volume) {\n    this.gainNode.gain.value = volume;\n  }\n\n  destroy() {\n    if (this.interval) {\n      clearInterval(this.interval);\n    }\n    this.samples = null;\n    this.audioCtx.close().then();\n    this.audioCtx = null;\n  }\n\n  flush() {\n    if (!this.samples.length) return;\n    const self = this;\n    const bufferSource = this.audioCtx.createBufferSource();\n    if (typeof this.option.onended === 'function') {\n      bufferSource.onended = function (event) {\n        self.option.onended(this, event);\n      };\n    }\n    const length = this.samples.length / this.option.channels;\n    const audioBuffer = this.audioCtx.createBuffer(this.option.channels, length, this.option.sampleRate);\n\n    for (let channel = 0; channel \u003c this.option.channels; channel++) {\n      const audioData = audioBuffer.getChannelData(channel);\n      let offset = channel;\n      let decrement = 50;\n      for (let i = 0; i \u003c length; i++) {\n        audioData[i] = this.samples[offset];\n        /* fadein */\n        if (i \u003c 50) {\n          audioData[i] = (audioData[i] * i) / 50;\n        }\n        /* fadeout*/\n        if (i \u003e= (length - 51)) {\n          audioData[i] = (audioData[i] * decrement--) / 50;\n        }\n        offset += this.option.channels;\n      }\n    }\n\n    if (this.startTime \u003c this.audioCtx.currentTime) {\n      this.startTime = this.audioCtx.currentTime;\n    }\n    // console.log('start vs current ' + this.startTime + ' vs ' + this.audioCtx.currentTime + ' duration: ' + audioBuffer.duration);\n    // console.log('start', this.startTime);\n    // console.log('duration', audioBuffer.duration);\n    bufferSource.buffer = audioBuffer;\n    bufferSource.connect(this.gainNode);\n    bufferSource.connect(this.analyserNode); // bufferSource连接到analyser\n    bufferSource.start(this.startTime);\n    this.option?.onstart(audioBuffer.duration);\n    this.startTime += audioBuffer.duration;\n    this.samples = new Float32Array();\n  }\n\n  async pause() {\n    await this.audioCtx.suspend();\n  }\n\n  async continue() {\n    await this.audioCtx.resume();\n  }\n\n  bindAudioContextEvent() {\n    const self = this;\n    if (typeof self.option.onstatechange === 'function') {\n      this.audioCtx.onstatechange = function (event) {\n        self.audioCtx \u0026\u0026 self.option.onstatechange(this, event, self.audioCtx.state);\n      };\n    }\n  }\n\n}\n\nexport default PCMPlayer;\n```","author":"z0ffy","reactions":{"url":"https://api.github.com/repos/z0ffy/z0ffy.github.io/issues/26/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"labels":["published","前端"]}},"__N_SSG":true},"page":"/post/[id]","query":{"id":"【小程序】播放 pcm 流"},"buildId":"vXWzReuGooTKnwalJT7qz","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>