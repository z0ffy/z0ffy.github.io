<!DOCTYPE html><html lang="zh-CN" id="html"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><title data-next-head="">【OSS】前端直传 oss</title><meta name="description" content="&gt; 在上传文件时，为了降低后端服务器压力、提高上传速度等。可由前端直接上传至oss。
&gt; 
&gt; 当使用 npm 的方式使用 oss sdk 时，build 可能会异常。可以采用 cdn 的方式使用。
&gt; 
&gt; Github：[ali-oss](https://github.com/ali-s" data-next-head=""/><meta name="keywords" content="【OSS】前端直传 oss" data-next-head=""/><meta name="author" content="zoffy" data-next-head=""/><meta property="og:title" content="【OSS】前端直传 oss" data-next-head=""/><meta property="og:description" content="&gt; 在上传文件时，为了降低后端服务器压力、提高上传速度等。可由前端直接上传至oss。
&gt; 
&gt; 当使用 npm 的方式使用 oss sdk 时，build 可能会异常。可以采用 cdn 的方式使用。
&gt; 
&gt; Github：[ali-oss](https://github.com/ali-s" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="og:url" content="https://zoffy.me" data-next-head=""/><link rel="shortcut icon" href="/favicon.ico"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/1d3e27d42a439302.css" as="style"/><link rel="preload" href="/_next/static/css/2eb74dcba05ea63c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1d3e27d42a439302.css" data-n-g=""/><link rel="stylesheet" href="/_next/static/css/2eb74dcba05ea63c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ffd07a3317375c1.js" defer=""></script><script src="/_next/static/chunks/framework-e9806f575cfe9302.js" defer=""></script><script src="/_next/static/chunks/main-db620d67651d390c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-dbf8774eddc5fa0f.js" defer=""></script><script src="/_next/static/chunks/914-e1d3cbc5fed1930c.js" defer=""></script><script src="/_next/static/chunks/690-fe9bc76f4be50fb7.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bid%5D-df315b19435a5c64.js" defer=""></script><script src="/_next/static/jpMvuf1hBD3ex9ZYOL0oK/_buildManifest.js" defer=""></script><script src="/_next/static/jpMvuf1hBD3ex9ZYOL0oK/_ssgManifest.js" defer=""></script></head><body class="dark:bg-black bg-slate-50"><div id="__next"><script>((e,i,s,u,m,a,l,h)=>{let d=document.documentElement,w=["light","dark"];function p(n){(Array.isArray(e)?e:[e]).forEach(y=>{let k=y==="class",S=k&&a?m.map(f=>a[f]||f):m;k?(d.classList.remove(...S),d.classList.add(a&&a[n]?a[n]:n)):d.setAttribute(y,n)}),R(n)}function R(n){h&&w.includes(n)&&(d.style.colorScheme=n)}function c(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}if(u)p(u);else try{let n=localStorage.getItem(i)||s,y=l&&n==="system"?c():n;p(y)}catch(n){}})("data-theme","theme","system",null,["light","dark"],null,true,true)</script><div class="flex flex-col h-screen container w-full md:w-3/4 xl:w-1/2"><header><div class="my-10 flex self-center flex-row justify-between"><div class="flex self-center flex-row justify-between"><a class="md:text-2xl text-xl cursor-pointer dark:hover:text-white dark:text-gray-400 text-gray-500 hover:text-black transition-colors duration-200 font-en" href="/">cd ..</a></div><div class="self-center text-sm sm:text-lg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2em" height="2em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M12 5q-.425 0-.712-.288Q11 4.425 11 4V2q0-.425.288-.713Q11.575 1 12 1t.713.287Q13 1.575 13 2v2q0 .425-.287.712Q12.425 5 12 5Zm4.95 2.05q-.275-.275-.275-.688q0-.412.275-.712l1.4-1.425q.3-.3.712-.3q.413 0 .713.3q.275.275.275.7q0 .425-.275.7L18.35 7.05q-.275.275-.7.275q-.425 0-.7-.275ZM20 13q-.425 0-.712-.288Q19 12.425 19 12t.288-.713Q19.575 11 20 11h2q.425 0 .712.287q.288.288.288.713t-.288.712Q22.425 13 22 13Zm-8 10q-.425 0-.712-.288Q11 22.425 11 22v-2q0-.425.288-.712Q11.575 19 12 19t.713.288Q13 19.575 13 20v2q0 .425-.287.712Q12.425 23 12 23ZM5.65 7.05l-1.425-1.4q-.3-.3-.3-.725t.3-.7q.275-.275.7-.275q.425 0 .7.275L7.05 5.65q.275.275.275.7q0 .425-.275.7q-.3.275-.7.275q-.4 0-.7-.275Zm12.7 12.725l-1.4-1.425q-.275-.3-.275-.712q0-.413.275-.688q.275-.275.688-.275q.412 0 .712.275l1.425 1.4q.3.275.287.7q-.012.425-.287.725q-.3.3-.725.3t-.7-.3ZM2 13q-.425 0-.712-.288Q1 12.425 1 12t.288-.713Q1.575 11 2 11h2q.425 0 .713.287Q5 11.575 5 12t-.287.712Q4.425 13 4 13Zm2.225 6.775q-.275-.275-.275-.7q0-.425.275-.7L5.65 16.95q.275-.275.688-.275q.412 0 .712.275q.3.3.3.713q0 .412-.3.712l-1.4 1.4q-.3.3-.725.3t-.7-.3ZM12 18q-2.5 0-4.25-1.75T6 12q0-2.5 1.75-4.25T12 6q2.5 0 4.25 1.75T18 12q0 2.5-1.75 4.25T12 18Zm0-2q1.65 0 2.825-1.175Q16 13.65 16 12q0-1.65-1.175-2.825Q13.65 8 12 8q-1.65 0-2.825 1.175Q8 10.35 8 12q0 1.65 1.175 2.825Q10.35 16 12 16Z"></path></svg></div></div></header><main class="grow"><div><div class="flex flex-col mb-2"><div class="text-4xl sm:text-4xl font-medium dark:text-gray-200">【OSS】前端直传 oss</div><div class="sm:text-lg text-sm mt-2 dark:text-gray-400"><span>2024年12月3日</span> / <span>1月1日</span></div></div><br/><div class="font-normal"><blockquote node="[object Object]" class="border-l-4 pl-4 border-gray-300 dark:border-gray-600 rounded-l-sm italic my-4">
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">在上传文件时，为了降低后端服务器压力、提高上传速度等。可由前端直接上传至oss。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">当使用 npm 的方式使用 oss sdk 时，build 可能会异常。可以采用 cdn 的方式使用。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">Github：<a href="https://github.com/ali-sdk/ali-oss" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">ali-oss</a></p>
</blockquote>
<h1 class="sm:text-4xl text-3xl my-12 mb-6 dark:text-white font-medium">实现逻辑</h1>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">如果是批量上传，则需控制上传队列，单个依次执行上传。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">单个文件上传简单逻辑如下：</p>
<ol node="[object Object]" class="sm:text-xl text-lg my-4 list-decimal pl-10 dark:text-gray-300">
<li class="list-none my-1">获取 oss config</li>
<li class="list-none my-1">初始化 oss sdk</li>
<li class="list-none my-1">执行分片上传
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">这里不论文件大小都采用分片上传的方式，目的是为了简化，统一逻辑。</li>
<li class="list-none my-1">可针对不同文件指定不同的分片数量（例如：文件小于1MB则分1片）</li>
</ul>
</li>
<li class="list-none my-1">上传成功后上报 oss path</li>
</ol>
<h1 class="sm:text-4xl text-3xl my-12 mb-6 dark:text-white font-medium">异常处理</h1>
<ol node="[object Object]" class="sm:text-xl text-lg my-4 list-decimal pl-10 dark:text-gray-300">
<li class="list-none my-1">初始化 oss sdk 需要有 token，由于token直接输出至前端，出于安全考虑 token 必须设置有效期，例如 5 分钟。因此客户端需 在 token 过期之前，提前刷新 token。防止 token 过期导致上传失败。
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">为什么 5 分钟有效期还不够用？客户端网络不可控</li>
</ul>
</li>
<li class="list-none my-1">在进行分片上传时，如果上传失败，可设置自动重试。重试次数可根据业务自定。
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">断点续传？可根据业务自行实现。</li>
</ul>
</li>
</ol>
<h1 class="sm:text-4xl text-3xl my-12 mb-6 dark:text-white font-medium">能力扩展</h1>
<ol node="[object Object]" class="sm:text-xl text-lg my-4 list-decimal pl-10 dark:text-gray-300">
<li class="list-none my-1">上传速度
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">上传开始前 记录当前时间为开始时间</li>
<li class="list-none my-1">通过上传的 progress 回调。可以获得上传进度，进而可以获取已上传的文件大小。如果以此刻为结束时间的话，那么就可大约计算出上传速度</li>
<li class="list-none my-1">由于 progress 回调频率不够高，如果需要更高频率显示，可自行实现加速逻辑。比如在一次 progress 回调中计算多次结果。</li>
</ul>
</li>
<li class="list-none my-1">单文件上传进度
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">通过 progress 回调根据已上传文件大小，计算得出当前上传进度。</li>
</ul>
</li>
<li class="list-none my-1">整体上传任务进度
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">如果需要显示批量的进度，则可在每个文件上传后或者每个文件的 progress 回调（更精细的进度显示）中计算。</li>
</ul>
</li>
<li class="list-none my-1">失败重试
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">在上传失败时可设置自动重试逻辑。超过最大重试次数则最终上传失败。</li>
</ul>
</li>
<li class="list-none my-1">针对不同文件设置不同分片
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">合理的分片能够更好的利用带宽，增加上传速度。</li>
<li class="list-none my-1">同域名下的浏览器并发限制为6个（不同浏览器，不同版本可能限制存在差异，主要目的是需要合理的限制并发数）</li>
<li class="list-none my-1">根据文件大小，以及并发数量，计算出分片数量以及每片大小。</li>
</ul>
</li>
<li class="list-none my-1">使用加速域名
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">如果客户端由于地域原因导致上传慢或者失败。可在上传失败时启用加速域名进行加速上传（修改oss config）。</li>
</ul>
</li>
<li class="list-none my-1">文件检查
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">在上传之前可简单进行文件类型，大小等检查。如果不符合业务则直接给出提示即可。</li>
</ul>
</li>
</ol>
<h1 class="sm:text-4xl text-3xl my-12 mb-6 dark:text-white font-medium">代码实现</h1>
<ul node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="list-none my-1">refreshSTSTokenInterval 可根据业务情况进行修改。</li>
<li class="list-none my-1">calcPart 可根据业务情况自行实现。</li>
</ul>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#07a">let</span><span> client</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span></span><span class="token" style="color:#07a">const</span><span> uploadConfig </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span>  </span><span class="token literal-property" style="color:#905">fileList</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">5</span><span>  </span><span class="token literal-property" style="color:#905">params</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Map</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">6</span><span>  </span><span class="token literal-property" style="color:#905">data</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">7</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">9</span><span></span><span class="token" style="color:#07a">const</span><span> </span><span class="token function-variable" style="color:#DD4A68">multipartUpload</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span class="token parameter">file</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">10</span><span>  </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">Promise</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span class="token parameter">resolve</span><span class="token parameter" style="color:#999">,</span><span class="token parameter"> reject</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">11</span><span>    </span><span class="token" style="color:#07a">const</span><span> res </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> </span><span class="token" style="color:#DD4A68">getOssConfig</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">12</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">13</span><span>    </span><span class="token" style="color:#07a">const</span><span> startTime </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Date</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">now</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">15</span><span>    client </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token" style="color:#DD4A68">OSS</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">16</span><span>      </span><span class="token spread" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">...</span><span class="token method property-access" style="color:#DD4A68">getStsConfig</span><span class="token" style="color:#999">(</span><span>uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">data</span><span class="token" style="color:#999">.</span><span class="token property-access">sts_config</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">17</span><span>      </span><span class="token function-variable" style="color:#DD4A68">refreshSTSToken</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">18</span><span>        </span><span class="token" style="color:#07a">const</span><span> info </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> </span><span class="token" style="color:#DD4A68">getOssConfig</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">19</span><span>        </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">20</span><span>          </span><span class="token literal-property" style="color:#905">accessKeyId</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> info</span><span class="token" style="color:#999">.</span><span class="token property-access">accessKeyId</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">21</span><span>          </span><span class="token literal-property" style="color:#905">accessKeySecret</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> info</span><span class="token" style="color:#999">.</span><span class="token property-access">accessKeySecret</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">22</span><span>          </span><span class="token literal-property" style="color:#905">stsToken</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> info</span><span class="token" style="color:#999">.</span><span class="token property-access">stsToken</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">23</span><span>        </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">24</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">25</span><span>      </span><span class="token literal-property" style="color:#905">refreshSTSTokenInterval</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> interval </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">60</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1000</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">26</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">27</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">28</span>    client
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">29</span><span>      </span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">multipartUpload</span><span class="token" style="color:#999">(</span><span>dir</span><span class="token" style="color:#999">,</span><span> file</span><span class="token" style="color:#999">.</span><span class="token property-access">file</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">30</span><span>        </span><span class="token function-variable" style="color:#DD4A68">progress</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span class="token parameter">p</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">31</span><span>          </span><span class="token" style="color:#07a">const</span><span> costTime </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span class="token known-class-name" style="color:#DD4A68">Date</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">now</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">-</span><span> startTime</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1000</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">32</span><span>          </span><span class="token" style="color:#07a">const</span><span> uploadedSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">(</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">file</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>size </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">||</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> p</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">33</span><span>          </span><span class="token" style="color:#07a">const</span><span> fileSpeed </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span>uploadedSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> costTime</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">toFixed</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">2</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">34</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">35</span><span>          </span><span class="token console" style="color:#DD4A68">console</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">table</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">36</span><span>            </span><span class="token string-property" style="color:#905">&#x27;0-name&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">37</span><span>            </span><span class="token string-property" style="color:#905">&#x27;1-fileSize&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">file</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>size </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">||</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#690">&#x27;M&#x27;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">38</span><span>            </span><span class="token string-property" style="color:#905">&#x27;2-progress&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> p </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">100</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#690">&#x27;%&#x27;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">39</span><span>            </span><span class="token string-property" style="color:#905">&#x27;3-costTime&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> costTime </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#690">&#x27;s&#x27;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">40</span><span>            </span><span class="token string-property" style="color:#905">&#x27;4-uploadedSize&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> uploadedSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#690">&#x27;M&#x27;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">41</span><span>            </span><span class="token string-property" style="color:#905">&#x27;5-fileSpeed&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> fileSpeed </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#690">&#x27;M/s&#x27;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">42</span><span>            </span><span class="token string-property" style="color:#905">&#x27;6-partSize&#x27;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#DD4A68">calcPart</span><span class="token" style="color:#999">(</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">file</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>size </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">||</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token property-access">partSize</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#690">&#x27;M&#x27;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">43</span><span>          </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">44</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">45</span><span>          uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">speedMap</span><span class="token" style="color:#999">[</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> fileSpeed</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">46</span><span>        </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">47</span><span>        </span><span class="token spread" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">...</span><span class="token method property-access" style="color:#DD4A68">calcPart</span><span class="token" style="color:#999">(</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">file</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>size </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">||</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">48</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">49</span><span>      </span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">then</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">(</span><span class="token parameter">res</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">50</span><span>        uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">retryMap</span><span class="token" style="color:#999">[</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">51</span><span>        </span><span class="token" style="color:#07a">delete</span><span> uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">speedMap</span><span class="token" style="color:#999">[</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">52</span><span>        </span><span class="token" style="color:#DD4A68">resolve</span><span class="token" style="color:#999">(</span><span>res</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">53</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">54</span><span>      </span><span class="token" style="color:#999">.</span><span class="token control-flow" style="color:#07a">catch</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span class="token parameter">err</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">55</span><span>        </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>err</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>message</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span class="token method property-access" style="color:#DD4A68">includes</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;expired&#x27;</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span><span> uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">retryMap</span><span class="token" style="color:#999">[</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">3</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">56</span><span>          </span><span class="token control-flow" style="color:#07a">try</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">57</span><span>            uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">retryMap</span><span class="token" style="color:#999">[</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">58</span><span>            uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">data</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> </span><span class="token" style="color:#DD4A68">getOssConfig</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">59</span><span>            </span><span class="token" style="color:#DD4A68">resolve</span><span class="token" style="color:#999">(</span><span class="token control-flow" style="color:#07a">await</span><span> </span><span class="token" style="color:#DD4A68">multipartUpload</span><span class="token" style="color:#999">(</span><span>file</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">60</span><span>          </span><span class="token" style="color:#999">}</span><span> </span><span class="token control-flow" style="color:#07a">catch</span><span> </span><span class="token" style="color:#999">(</span><span>e</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">61</span><span>            </span><span class="token" style="color:#DD4A68">reject</span><span class="token" style="color:#999">(</span><span>e</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">62</span><span>          </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">63</span><span>        </span><span class="token" style="color:#999">}</span><span> </span><span class="token control-flow" style="color:#07a">else</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">64</span><span>          uploadConfig</span><span class="token" style="color:#999">.</span><span class="token property-access">retryMap</span><span class="token" style="color:#999">[</span><span>file</span><span class="token" style="color:#999">.</span><span class="token property-access">name</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">65</span><span>          </span><span class="token" style="color:#DD4A68">reject</span><span class="token" style="color:#999">(</span><span>err</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>message </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">||</span><span> err</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>name</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">66</span><span>        </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">67</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">68</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">69</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">70</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">71</span><span></span><span class="token" style="color:#07a">function</span><span> </span><span class="token" style="color:#DD4A68">calcPart</span><span class="token" style="color:#999">(</span><span class="token parameter">size</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">72</span><span>  </span><span class="token" style="color:#07a">const</span><span> mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> size </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">1024</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">73</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">74</span><span>  </span><span class="token" style="color:#07a">const</span><span> config </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">75</span><span>    </span><span class="token literal-property" style="color:#905">parallel</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">6</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">76</span><span>    </span><span class="token literal-property" style="color:#905">partSize</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> size</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">77</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">78</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">79</span><span>  </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#905">12</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span><span> mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;=</span><span> </span><span class="token" style="color:#905">50</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">80</span><span>    config</span><span class="token" style="color:#999">.</span><span class="token property-access">partSize</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Math</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">ceil</span><span class="token" style="color:#999">(</span><span>mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">6</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1024</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">81</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">82</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">83</span><span>  </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#905">50</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span><span> mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;=</span><span> </span><span class="token" style="color:#905">100</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">84</span><span>    config</span><span class="token" style="color:#999">.</span><span class="token property-access">partSize</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Math</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">ceil</span><span class="token" style="color:#999">(</span><span>mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">12</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1024</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">85</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">86</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">87</span><span>  </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#905">100</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">88</span><span>    config</span><span class="token" style="color:#999">.</span><span class="token property-access">partSize</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Math</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">ceil</span><span class="token" style="color:#999">(</span><span>mbSize </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">/</span><span> </span><span class="token" style="color:#905">18</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1024</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> </span><span class="token" style="color:#905">1024</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">89</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">90</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">91</span><span>  </span><span class="token control-flow" style="color:#07a">return</span><span> config</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">92</span><span></span><span class="token" style="color:#999">}</span></code></div></pre></div><br/><div></div><a class="float-right mt-10 sm:text-2xl text-xl text-gray-500 hover:text-black transition-colors duration-200 dark:text-gray-400 dark:hover:text-gray-100" href="/">cd ..</a></div></main><footer class="container mx-auto text-center text-gray-700 dark:text-gray-400"><div class="flex flex-row justify-center mb-5 space-x-5"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" fill-rule="evenodd" d="M3.5 3.25a.75.75 0 0 1 .75-.75C14.053 2.5 22 10.447 22 20.25a.75.75 0 0 1-1.5 0C20.5 11.275 13.225 4 4.25 4a.75.75 0 0 1-.75-.75zM3.5 19a2 2 0 1 1 4 0a2 2 0 0 1-4 0zm.75-9.5a.75.75 0 0 0 0 1.5a9.25 9.25 0 0 1 9.25 9.25a.75.75 0 0 0 1.5 0C15 14.313 10.187 9.5 4.25 9.5z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M4 20q-.825 0-1.412-.587Q2 18.825 2 18V6q0-.825.588-1.412Q3.175 4 4 4h16q.825 0 1.413.588Q22 5.175 22 6v12q0 .825-.587 1.413Q20.825 20 20 20ZM20 8l-7.475 4.675q-.125.075-.263.112q-.137.038-.262.038t-.262-.038q-.138-.037-.263-.112L4 8v10h16Zm-8 3l8-5H4ZM4 8v.25v-1.475v.025V6v.8v-.013V8.25V8v10Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" cursor="pointer" viewBox="0 0 16 16"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.75 14.25s-.5-2 .5-3c0 0-2 0-3.5-1.5s-1-4.5 0-5.5c-.5-1.5.5-2.5.5-2.5s1.5 0 2.5 1c1-.5 3.5-.5 4.5 0c1-1 2.5-1 2.5-1s1 1 .5 2.5c1 1 1.5 4 0 5.5s-3.5 1.5-3.5 1.5c1 1 .5 3 .5 3m-5-.5c-1.5.5-3-.5-3.5-1"></path></svg></div><div class="flex items-center flex-wrap mb-10 font-en justify-center"><span>©<!-- -->2025<!-- -->. </span><span>All rights reserved by </span><a href="https://github.com/z0ffy" class="text-blue-500 hover:text-blue-900 transition-colors duration-300">z0ffy</a><span>.</span></div></footer><div class="bottom-10 right-10 cursor-pointer fixed hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="opacity-0 duration-700 transition-opacity ease-in-out"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19h14a2 2 0 0 0 1.84-2.75L13.74 4a2 2 0 0 0-3.5 0l-7.1 12.25A2 2 0 0 0 4.89 19"></path></svg></div><div id="sakana-widget" class="cursor-pointer bottom-0 left-16 fixed hidden xl:block"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":24,"title":"【OSS】前端直传 oss","created_at":"2024-12-03T09:20:59Z","updated_at":"2025-01-01T17:32:24Z","content":"\u003e 在上传文件时，为了降低后端服务器压力、提高上传速度等。可由前端直接上传至oss。\r\n\u003e \r\n\u003e 当使用 npm 的方式使用 oss sdk 时，build 可能会异常。可以采用 cdn 的方式使用。\r\n\u003e \r\n\u003e Github：[ali-oss](https://github.com/ali-sdk/ali-oss)\r\n\r\n### 实现逻辑\r\n\r\n如果是批量上传，则需控制上传队列，单个依次执行上传。\r\n\r\n单个文件上传简单逻辑如下：\r\n\r\n1. 获取 oss config\r\n2. 初始化 oss sdk\r\n3. 执行分片上传\r\n   - 这里不论文件大小都采用分片上传的方式，目的是为了简化，统一逻辑。\r\n   - 可针对不同文件指定不同的分片数量（例如：文件小于1MB则分1片）\r\n4. 上传成功后上报 oss path\r\n\r\n### 异常处理\r\n\r\n1. 初始化 oss sdk 需要有 token，由于token直接输出至前端，出于安全考虑 token 必须设置有效期，例如 5 分钟。因此客户端需 在 token 过期之前，提前刷新 token。防止 token 过期导致上传失败。\r\n   - 为什么 5 分钟有效期还不够用？客户端网络不可控\r\n2. 在进行分片上传时，如果上传失败，可设置自动重试。重试次数可根据业务自定。\r\n   - 断点续传？可根据业务自行实现。\r\n\r\n### 能力扩展\r\n\r\n1. 上传速度\r\n   - 上传开始前 记录当前时间为开始时间\r\n   - 通过上传的 progress 回调。可以获得上传进度，进而可以获取已上传的文件大小。如果以此刻为结束时间的话，那么就可大约计算出上传速度\r\n   - 由于 progress 回调频率不够高，如果需要更高频率显示，可自行实现加速逻辑。比如在一次 progress 回调中计算多次结果。\r\n2. 单文件上传进度\r\n   - 通过 progress 回调根据已上传文件大小，计算得出当前上传进度。\r\n3. 整体上传任务进度\r\n   - 如果需要显示批量的进度，则可在每个文件上传后或者每个文件的 progress 回调（更精细的进度显示）中计算。 \r\n4. 失败重试\r\n   - 在上传失败时可设置自动重试逻辑。超过最大重试次数则最终上传失败。\r\n5. 针对不同文件设置不同分片\r\n    - 合理的分片能够更好的利用带宽，增加上传速度。\r\n    - 同域名下的浏览器并发限制为6个（不同浏览器，不同版本可能限制存在差异，主要目的是需要合理的限制并发数）\r\n    - 根据文件大小，以及并发数量，计算出分片数量以及每片大小。\r\n6. 使用加速域名\r\n   - 如果客户端由于地域原因导致上传慢或者失败。可在上传失败时启用加速域名进行加速上传（修改oss config）。\r\n7. 文件检查\r\n   - 在上传之前可简单进行文件类型，大小等检查。如果不符合业务则直接给出提示即可。\r\n\r\n### 代码实现\r\n\r\n- refreshSTSTokenInterval 可根据业务情况进行修改。\r\n- calcPart 可根据业务情况自行实现。\r\n\r\n```javascript\r\nlet client;\r\n\r\nconst uploadConfig = {\r\n  fileList: [],\r\n  params: new Map(),\r\n  data: {},\r\n};\r\n\r\nconst multipartUpload = (file) =\u003e {\r\n  return new Promise(async (resolve, reject) =\u003e {\r\n    const res = await getOssConfig();\r\n\r\n    const startTime = Date.now();\r\n\r\n    client = new OSS({\r\n      ...getStsConfig(uploadConfig.data.sts_config),\r\n      refreshSTSToken: async () =\u003e {\r\n        const info = await getOssConfig();\r\n        return {\r\n          accessKeyId: info.accessKeyId,\r\n          accessKeySecret: info.accessKeySecret,\r\n          stsToken: info.stsToken,\r\n        };\r\n      },\r\n      refreshSTSTokenInterval: interval * 60 * 1000,\r\n    });\r\n\r\n    client\r\n      .multipartUpload(dir, file.file, {\r\n        progress: (p) =\u003e {\r\n          const costTime = (Date.now() - startTime) / 1000;\r\n          const uploadedSize = ((file.file?.size || 0) * p) / 1024 / 1024;\r\n          const fileSpeed = (uploadedSize / costTime).toFixed(2);\r\n\r\n          console.table({\r\n            '0-name': file.name,\r\n            '1-fileSize': (file.file?.size || 0) / 1024 / 1024 + 'M',\r\n            '2-progress': p * 100 + '%',\r\n            '3-costTime': costTime + 's',\r\n            '4-uploadedSize': uploadedSize + 'M',\r\n            '5-fileSpeed': fileSpeed + 'M/s',\r\n            '6-partSize': calcPart(file.file?.size || 0).partSize / 1024 / 1024 + 'M',\r\n          });\r\n\r\n          uploadConfig.speedMap[file.name] = fileSpeed;\r\n        },\r\n        ...calcPart(file.file?.size || 0),\r\n      })\r\n      .then((res) =\u003e {\r\n        uploadConfig.retryMap[file.name] = 0;\r\n        delete uploadConfig.speedMap[file.name];\r\n        resolve(res);\r\n      })\r\n      .catch(async (err) =\u003e {\r\n        if (err?.message?.includes('expired') \u0026\u0026 uploadConfig.retryMap[file.name] \u003c 3) {\r\n          try {\r\n            uploadConfig.retryMap[file.name] += 1;\r\n            uploadConfig.data = await getOssConfig();\r\n            resolve(await multipartUpload(file));\r\n          } catch (e) {\r\n            reject(e);\r\n          }\r\n        } else {\r\n          uploadConfig.retryMap[file.name] = 0;\r\n          reject(err?.message || err?.name);\r\n        }\r\n      });\r\n  });\r\n};\r\n\r\nfunction calcPart(size) {\r\n  const mbSize = size / 1024 / 1024;\r\n\r\n  const config = {\r\n    parallel: 6,\r\n    partSize: size,\r\n  };\r\n\r\n  if (mbSize \u003e 12 \u0026\u0026 mbSize \u003c= 50) {\r\n    config.partSize = Math.ceil(mbSize / 6) * 1024 * 1024;\r\n  }\r\n\r\n  if (mbSize \u003e 50 \u0026\u0026 mbSize \u003c= 100) {\r\n    config.partSize = Math.ceil(mbSize / 12) * 1024 * 1024;\r\n  }\r\n\r\n  if (mbSize \u003e 100) {\r\n    config.partSize = Math.ceil(mbSize / 18) * 1024 * 1024;\r\n  }\r\n\r\n  return config;\r\n}\r\n```\r\n","author":"z0ffy","reactions":{"url":"https://api.github.com/repos/z0ffy/z0ffy.github.io/issues/24/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"labels":["published","前端"]}},"__N_SSG":true},"page":"/post/[id]","query":{"id":"【OSS】前端直传 oss"},"buildId":"jpMvuf1hBD3ex9ZYOL0oK","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>